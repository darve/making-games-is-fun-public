!function(e,t,n,o,a){"use strict";var i=o.module(a,[a+".controllers",a+".services",a+".filters","ngRoute"]);i.config(["$routeProvider",function(e){e.when("/",{}),e.when("/about",{}),e.when("/support-us",{}),e.when("/login",{}),e.when("/chapter/:chapter/:page",{}),e.when("/chapter/:chapter/:page/:photo",{}),e.otherwise({redirectTo:"/"})}]),i.run(["$timeout","$rootScope","$http","$location","$route","animLoop","windowResizer",function(e,t,n,o,a,i){var r=o.path;o.path=function(e,n){if(n===!1)var i=a.current,c=t.$on("$locationChangeSuccess",function(){a.current=i,c()});return r.apply(o,[e])},setTimeout(function(){window.scrollTo(0,1)},0),i.setFPS(60),i.add("tween",TWEEN.update),i.start()}])}(window,document,navigator,window.angular,"BBHApp"),function(e,t,n,o,a){"use strict";var i=n.module(o+"."+a,[o+".services"]);i.directive("bbhContent",["$rootScope","$timeout",function(){return{restrict:"A",template:function(){return"<p></p>"},transclude:!0,replace:!0,link:function(){}}}]),i.directive("carousel",["$rootScope","$timeout",function(e,t){return{restrict:"A",link:function(e,n){function o(){c=setInterval(function(){s=r>l?l+1:0,i.removeClass("on"),i.eq(s).addClass("on"),l=s},3e3),e.$on("$destroy",function(){clearInterval(c)})}function a(){u++,u==r&&o()}var i,r,c,s,p=[],l=0,u=0;t(function(){i=n.find(".section"),r=i.length-1;for(var e=0;r>e;e++)p.push(new Image),p[e].onload=a,p[e].src=i[e].getAttribute("data-photo")})}}}])}(window,document,window.angular,"BBHApp","directives"),function(e,t,n,o,a){"use strict";var i=n.module(o+"."+a,[]);i.filter("slugify",function(){return function(e){return e.toLowerCase().split("Ã©").join("e").replace(/[^\w\s-]/g,"").replace(/[-\s]+/g,"-")}}),i.filter("capitalize",function(){return function(e){return e.charAt(0).toUpperCase()+e.slice(1)}}),i.filter("reverse",function(){return function(e){return e.slice().reverse()}})}(window,document,window.angular,"BBHApp","filters"),function(e,t,n,o,a){"use strict";var i=n.module(o+"."+a,[]);i.factory("$sanitize",[function(){return function(e){return e.replace("\n","").replace("	","").replace("\r","").replace(/^\s+/g,"")}}]),i.factory("$photo",["$rootScope","$timeout","windowSize",function(e){function n(t){e.$broadcast("photo event",{loading:!0,showing:!0,photo:""}),i.onload=function(){i.onload=void 0,i.src="",a="background: transparent url("+t+") center center no-repeat; background-size: cover;",e.$broadcast("photo event",{loading:!1,showing:!0,photo:a})},i.src=t}function o(){}var a,i=t.createElement("img");return{show:n,update:o}}]),i.factory("$modal",["$rootScope","$compile","$timeout","$sanitize","$templateCache","windowSize",function(e,t,o,a,i){function r(){l.addClass("show"),w=!0,h.addClass("modal-showing")}function c(t){w=!1,l.removeClass("show").removeAttr("style"),u.html(""),t!==!1&&e.$broadcast("modal closed"),h.removeClass("modal-showing")}function s(){l.toggleClass("show")}function p(e,o,r,c){f=i.get(e),r=void 0!==c?n.extend(r.$new(),{data:n.extend({},c)}):r,g=t(a(f))(r),u.html("").append(g),o===!0&&(l.addClass("show"),u.addClass("show"),h.addClass("modal-showing")),w=!0}var l,u,d,h,f,g,w=!1;return h=$("body"),l=n.element(i.get("modal.html")),u=l.find("#modal-content"),d=l.find("#modal-close"),h.append(l[0]),d.bind("click",c),{showing:w,show:r,hide:c,toggle:s,load:p}}]),i.factory("ChapterService",["$rootScope","$q","$http","$templateCache","$compile","$sanitize","$routeParams","$location",function(e,o,a,i,r,c){function s(){var e=new o.defer;return a({url:"/assets/data/chapters.json",type:"GET"}).then(function(t){e.resolve(t.data)},function(){e.reject("error retrieving the chapter map")}),e.promise}function p(t){var n=o.defer();return v[t]?n.resolve(v[t]):a({url:"/assets/data/chapters/"+t+".json",type:"GET"}).then(function(o){v[t]=o.data,e.$broadcast("chapter loaded",o.data),n.resolve(o.data)},function(){e.$broadcast("error","this chapter does not exist"),n.reject("this chapter does not exist")}),n.promise}function l(e,t,n){return v[e]?(v[e].pages[t-1].content[n]&&null!==v[e].pages[t-1].content[n].type&&f(v[e].pages[t-1].content[n].content),v[e].pages[t-1].photos[n-1].replace(".jpg","-full.jpg")):void 0}function u(e,t,o){var a=v[e].pages[t-1].photos;return n.forEach(a,function(e,t){a[t]=a[t].replace(".jpg","-full.jpg")}),{current:parseInt(o-1),photos:a}}function d(e,t,n){var a=new o.defer;return 1===e&&0===t?a.reject("go to homepage"):p(e).then(function(o){var i=o.pages.length;0===t?p(parseInt(e)-1).then(function(t){var o=t.pages.length;a.resolve({template:h(t,o,n),chapter:parseInt(e)-1,page:o})},a.reject):t>i?p(parseInt(e)+1).then(function(t){a.resolve({template:h(t,1,n),chapter:parseInt(e)+1,page:1})},a.reject):a.resolve({template:h(o,t,n),chapter:e,page:t})},function(){a.reject()}),a.promise}function h(t,o,a){var s,p;return e.$broadcast("title changed",t.title),e.$broadcast("page type changed",t.pages[o-1].type),e.$broadcast("number of photos changed",t.pages[o-1].photos.length),t.pages[o-1].content.length&&null!==t.pages[o-1].content[0].type?f(t.pages[o-1].content[0].content):e.$broadcast("narrative hidden"),s=i.get("page-"+t.pages[o-1].type+".html"),p=n.extend(a.$new(),t.pages[o-1]),r(c(s))(p)}function f(o){var a=t.createElement("div");n.forEach(o,function(n){var o;switch(n.type){case"heading":o=t.createElement("h2"),e.$broadcast("photo title",n.value);break;case"subheading":o=t.createElement("h3");break;case"paragraph":o=t.createElement("p")}o.innerHTML=n.value,a.appendChild(o)}),e.$broadcast("narrative updated",a)}function g(e,t,n){v[e].pages[t-1].content.length&&null!==v[e].pages[t-1].content[n].type&&f(v[e].pages[t-1].content[n].content)}function w(t,n){try{var o=[],a=[],i=0;v[t].pages[n-1]&&(o=o.concat(v[t].pages[n-1].photos)),v[t].pages[n]&&(o=o.concat(v[t].pages[n].photos)),v[t].pages[n-2]&&(o=o.concat(v[t].pages[n-2].photos));for(var r in o)a.push(new Image),a[r].onload=function(){i++,i===o.length&&e.$broadcast("preload complete")},a[r].src=e.assetUrl+o[r]}catch(c){console.log("could not preload the images")}}var v={};return{getChapter:p,getChapters:s,getPhoto:l,getPhotos:u,getNarrative:g,getPage:d,preloadPages:w}}]),i.factory("animLoop",function(){var e=0,t=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){var n=(new Date).getTime(),o=Math.max(0,16-(n-e)),a=window.setTimeout(function(){t(n+o)},o);return e=n+o,a}}(),n=function(){return window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelAnimationFrame||window.mozCancelRequestAnimationFrame||function(e){clearTimeout(e)}}(),o=function(){var e=this;e.pipeline={},e.then=(new Date).getTime(),e.now=void 0,e.raf=void 0,e.delta=void 0,e.interval=1e3/60,e.running=!1};o.prototype={add:function(e,t){this.pipeline[e]=t},remove:function(e){delete this.pipeline[e]},start:function(){this.running||(this._tick(),this.running=!0)},pause:function(){this.running&&(n.call(window,this.raf),this.running=!1)},setFPS:function(e){this.interval=1e3/e},_tick:function i(){var e=this;if(e.raf=t.call(window,i.bind(e)),e.now=(new Date).getTime(),e.delta=e.now-e.then,e.delta>e.interval){for(var n in e.pipeline)e.pipeline[n]();e.then=e.now-e.delta%e.interval}}};var a=new o;return Function.prototype.bind=Function.prototype.bind||function(){return function(e){var t=this,n=Array.prototype.slice.call(arguments,1);return n.length?function(){return arguments.length?t.apply(e,n.concat(Array.prototype.slice.call(arguments))):t.apply(e,n)}:function(){return arguments.length?t.apply(e,arguments):t.apply(e)}}},a}),i.factory("windowScroll",[function(){var e=null===t.querySelector(".lte9")?t.body:t.documentElement,n=function(t){new TWEEN.Tween({y:e.scrollTop}).to({y:t},600).easing(TWEEN.Easing.Cubic.Out).onUpdate(function(){e.scrollTop=this.y}).start()};return{scrollTo:n}}]),i.factory("windowSize",["$timeout",function(){var n=function(){if("undefined"!=typeof e.innerWidth)return function(){return e.innerWidth};var n="clientWidth"in t.documentElement?t.documentElement:t.body;return function(){return n.clientWidth}}(),o=function(){if("undefined"!=typeof e.innerHeight)return function(){return e.innerHeight};var n="clientHeight"in t.documentElement?t.documentElement:t.body;return function(){return n.clientHeight}}();return{ww:n,width:n,wh:o,height:o}}]),i.factory("windowResizer",["$timeout","$rootScope","windowSize","animLoop",function(t,n,o,a){function i(){t(function(){n.$apply(function(){n.$broadcast("window resized",r,c)})}),a.remove("windowResize")}var r=o.ww(),c=o.wh();return e.onresize=function(){r=o.ww(),c=o.wh(),a.add("windowResize",i)},this}])}(window,document,window.angular,"BBHApp","services"),function(e,t,n,o,a){"use strict";var i=n.module(o+"."+a,[o+".services",o+".directives"]);i.controller("AppController",["$scope","$rootScope","$timeout","$location","$templateCache","$compile","$modal","ChapterService","windowScroll","windowSize","$routeParams",function(e,t,n,o,a,i,r,c,s,p){function l(){var e,n=o.path();switch(-1!==n.indexOf("chapter")?(e="chapter",u.addClass("story"),u.css("padding-top",p.wh()+"px")):(u.css("padding-top","0"),u.removeClass("story")),n){case"/":e="home",s.scrollTo(0);break;case"/about":e="about",s.scrollTo(0),u.removeClass("story");break;case"/support-us":e="support-us",s.scrollTo(0),u.removeClass("story")}window.ga("send","pageview"),t.route=e}t.assetUrl="http://darve-bbh.s3.amazonaws.com/";var u=$("body");e.showChapterChooser=function(){c.getChapters().then(function(t){r.load("modal-chapter-browser.html",!0,e,t)})},e.scrollToNarrative=function(){s.scrollTo(p.wh())},e.showMenu=function(){r.load("modal-menu.html",!0,e)},e.home=function(){o.path("/"),n(function(){o.path("/",!0),r.hide(!1)})},e.about=function(){o.path("/"),n(function(){o.path("/about",!0),r.hide(!1)})},e.support=function(){o.path("/"),n(function(){o.path("/support-us",!0),r.hide(!1)})},e.jump=function(e){t.$broadcast("navigate",e),r.hide()},t.$on("$locationChangeSuccess",l),l()}]),i.controller("HomeController",["$scope","$interval","$timeout","$modal",function(e,t,n,o){var a=$("body"),i=$("#home .photo"),r=$("#home .text"),c=["fun","stressful","exciting"],s=0;o.hide(),a.removeClass("narrative-showing");var p=setInterval(function(){var e=2>s?s+1:0;i.filter("."+c[e]).addClass("on"),i.filter("."+c[s]).removeClass("on"),r.filter("."+c[e]).addClass("on"),r.filter("."+c[s]).removeClass("on"),s=e},3e3);e.$on("$destroy",function(){clearInterval(p)})}]),i.controller("UIController",["$rootScope","$scope","$routeParams","ChapterService","$templateCache","$compile","$sanitize","$location","$modal","$timeout","$photo","windowSize","windowResizer",function(e,n,o,a,i,r,c,s,p,l,u,d){n.chapter=parseInt(o.chapter),n.page=parseInt(o.page),n.photo=parseInt(o.photo)||void 0,n.numphotos=void 0,n.type=void 0,n.title=void 0,n.loading=!1,n.data={},n.init=!1,n.width=d.ww(),n.height=d.wh();var h=$("#page-wrapper"),f=$("body");n.$on("window resized",function(t,o,a){"chapter"===e.route&&o!==n.width&&f.css("padding-top",a+"px"),n.width=o,n.height=a}),n.showMenu=function(){p.load("modal-menu.html",!0,n)},e.$on("$locationChangeSuccess",function(){if($("body").scrollTop(0),-1!==s.path().indexOf("chapter")){var e=s.path().split("/");e.shift(),l(function(){n.$apply(function(){n.chapter=parseInt(e[1]),n.page=parseInt(e[2]),n.photo=parseInt(e[3])||void 0})})}}),n.$watch("photo",function(t,o){if(void 0!==t&&t!==o&&void 0!==a.getPhoto(n.chapter,n.page,t)){var i=e.assetUrl+a.getPhoto(n.chapter,n.page,t);u.show(i,n.chapter,n.page)}}),n.navigateLeft=function(){e.$broadcast("navigate left")},n.navigateRight=function(){e.$broadcast("navigate right")},n.jump=function(){},n.transition=function(e){a.preloadPages(n.chapter,e.page.order,n)},n.$on("preload complete",function(){l(function(){n.$apply(function(){n.loading=!1})})}),n.$on("navigate",function(e,t){n.navigate(parseInt(t),1)}),n.$on("navigate left",function(){n.navigate(parseInt(n.chapter),parseInt(n.page)-1)}),n.$on("navigate right",function(){n.navigate(parseInt(n.chapter),parseInt(n.page)+1)}),n.$on("modal closed",function(){}),n.$on("photo event",function(e,t){"showing"in t&&t.showing===!0?(h.addClass("hide"),f.addClass("photo-showing")):"showing"in t&&t.showing===!1&&(h.removeClass("hide"),f.removeClass("photo-showing"),n.navigate(parseInt(n.chapter),parseInt(n.page)))}),n.$on("number of photos changed",function(e,t){l(function(){n.$apply(function(){n.numphotos=t})})}),n.$on("title changed",function(e,t){l(function(){n.$apply(function(){n.title=t})})}),n.navigate=function(t,o,i,r){n.loading=!0,a.getPage(t,o,n).then(function(c){a.preloadPages(t,o,n);var p=h.find(".transition.in"),d=h.find(".transition.out").html("").append(c.template);if(n.chapter=c.chapter,n.page=c.page,!r)if(void 0===i)s.path("/chapter/"+c.chapter+"/"+c.page,!1);else{var f=e.assetUrl+a.getPhoto(n.chapter,n.page,i);u.show(f),s.path("/chapter/"+c.chapter+"/"+c.page+"/"+i,!1)}p.removeClass("in").addClass("out"),d.removeClass("out").addClass("in"),l(function(){n.$apply(function(){n.chapter=c.chapter,n.page=c.page})}),window.ga("send","pageview"),"function"==typeof callback&&callback()},function(){s.path("/",!1)})},$(t).on("keydown",function(t){37===t.keyCode||39===t.keyCode?(t.preventDefault(),p.hide(),e.$broadcast(37===t.keyCode?"navigate left":"navigate right")):27===t.keyCode&&(t.preventDefault(),p.hide())}),n.$on("$destroy",function(){$(t).off("keydown"),f.removeClass("story")}),l(function(){"chapter"===e.route?n.navigate(o.chapter,o.page,o.photo):n.navigate(1,1,n.photo,!0)})}]),i.controller("PhotoController",["$rootScope","$scope","$timeout","windowSize","windowScroll","$photo",function(e,t,o){$("#photo-wrapper");t.loading=!0,t.showing=!1,t.photo="",t.title="",t.$on("photo event",function(e,a){o(function(){t.$apply(function(){n.extend(t,a)})})}),t.$on("photo title",function(e,n){o(function(){t.$apply(function(){t.title=n})})}),t.close=function(){e.$broadcast("photo event",{loading:!0,showing:!1,photo:""})}}]),i.controller("NarrativeController",["$rootScope","$scope","$timeout","windowSize","windowScroll","$location",function(e,t,n,o,a){function i(e,n){t.type=n}function r(){n(function(){t.$apply(function(){t.narrativeVisible=!t.narrativeVisible})})}function c(e,t){h.addClass("narrative-showing"),u.find("div").remove(),u.append(t),l.addClass("show"),d.addClass("flash")}function s(){l.addClass("show")}function p(){h.removeClass("narrative-showing"),l.removeClass("show"),d.removeClass("flash"),u.find("div").remove()}var l=$("#narrative-wrapper"),u=$("#narrative-content"),d=$("#story-indicator"),h=$("body");t.showing=!1,t.narrativeVisible=!1,t.close=function(){a.scrollTo(0)},t.getPageType=function(){var e=t.narrativeVisible===!0?" visible":"";return t.type+e},t.$on("narrative updated",c),t.$on("narrative shown",s),t.$on("narrative hidden",p),t.$on("toggle narrative",r),t.$on("page type changed",i)}])}(window,document,window.angular,"BBHApp","controllers");